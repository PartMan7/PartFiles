exports.id=6904,exports.ids=[6904],exports.modules={96487:()=>{},78335:()=>{},60809:(e,t,r)=>{"use strict";r.d(t,{j2:()=>w,Y9:()=>c});var n=r(57971),i=r(23352),a=r(34926),s=r(84908);let o={pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role),e),authorized({auth:e,request:{nextUrl:t,headers:r}}){let n=e?.user?.role,i=!!e?.user&&!!n,a=t.pathname;if(a.startsWith("/login")||a.startsWith("/invite")||a.startsWith("/api/auth")||a.startsWith("/api/invite")||a.startsWith("/api/preview")||/^(\/api\/content\/[^/]+(\/raw)?)$/.test(a)||/^(\/(c|r|s|e)\/[^/]+)$/.test(a)||a.startsWith("/api/cron"))return!0;let s=function(e,t){let r=t.get("x-forwarded-host"),n=t.get("x-forwarded-proto")||"https";return r?`${n}://${r}`:e.origin}(t,r);if(!i){if(r.get("x-forwarded-host")){let e=new URL("/login",s);return e.searchParams.set("callbackUrl",t.pathname+t.search),Response.redirect(e)}return!1}return!((a.startsWith("/admin")||a.startsWith("/api/admin"))&&"admin"!==n||("/upload"===a||a.startsWith("/api/upload"))&&"admin"!==n&&"uploader"!==n)||Response.redirect(new URL("/dashboard",s))}},providers:[],session:{strategy:"jwt"}},l=new Map,u=Date.now();function d(){let e=Date.now();if(!(e-u<3e5))for(let[t,r]of(u=e,l))e>r.resetAt&&l.delete(t)}let{handlers:c,signIn:p,signOut:f,auth:w}=(0,n.Ay)({...o,callbacks:{...o.callbacks,async jwt({token:e,user:t}){if(t)return e.id=t.id,e.role=t.role,e.revalidatedAt=Date.now(),e;let r=e.revalidatedAt??0;if(Date.now()-r>3e5){let t=await s.z.user.findUnique({where:{id:e.id},select:{id:!0,role:!0}});if(!t)return e.id=void 0,e.role=void 0,e.revalidatedAt=void 0,e;e.role=t.role,e.revalidatedAt=Date.now()}return e}},providers:[(0,i.A)({name:"credentials",credentials:{username:{label:"Username",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.username||!e?.password)return null;let t=e.username.toLowerCase(),r=e.password;if(function(e){d();let t=Date.now(),r=l.get(e);return!!r&&!(t>r.resetAt)&&r.failures>=5}(t))return null;let n=await s.z.user.findUnique({where:{username:t}});return n&&(0,a.Dm)(r,n.passwordHash)?(l.delete(t),{id:n.id,name:n.username,role:n.role}):(function(e){d();let t=Date.now(),r=l.get(e);!r||t>r.resetAt?l.set(e,{failures:1,resetAt:t+9e5}):(r.failures++,r.failures)}(t),null)}})]})},21950:(e,t,r)=>{"use strict";r.d(t,{AW:()=>p,C1:()=>c,ED:()=>l,S_:()=>f,bD:()=>d,gg:()=>a,pD:()=>s,w3:()=>o,y2:()=>u});var n=r(33873),i=r.n(n);let a=["admin","uploader","guest"],s={admin:0x80000000,uploader:524288e3,guest:0},o=0x6400000,l=168,u=1,d=5,c=new Set([".jpg",".jpeg",".png",".gif",".webp",".bmp",".ico",".tiff",".avif",".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".odt",".ods",".odp",".txt",".csv",".rtf",".zip",".tar",".gz",".bz2",".7z",".rar",".mp3",".mp4",".wav",".ogg",".webm",".avi",".mov",".flv",".mkv",".json",".xml",".yaml",".yml",".woff",".woff2",".ttf",".otf",".eot"]),p=new Set([".html",".htm",".js",".jsx",".ts",".tsx",".svg",".php",".asp",".aspx",".jsp",".cgi",".sh",".bash",".bat",".cmd",".exe",".msi",".dll",".so",".dylib",".phtml",".phar",".htaccess",".htpasswd",".xslt"]),f=process.env.UPLOAD_DIR||i().join(process.cwd(),"uploads");if((process.env.AUTH_SECRET||process.env.NEXTAUTH_SECRET||"").length<32)throw Error("AUTH_SECRET (or NEXTAUTH_SECRET) must be set and at least 32 characters in production. Generate one with: openssl rand -base64 32")},82085:(e,t,r)=>{"use strict";r.d(t,{y:()=>s});var n=r(55511),i=r(84908);let a="abcdefghijklmnopqrstuvwxyz0123456789";async function s(e=5){for(let t=0;t<e;t++){let e=function(){let e=(0,n.randomBytes)(6),t="";for(let r=0;r<6;r++)t+=a[e[r]%a.length];return t}();if(!await i.z.content.findUnique({where:{id:e}}))return e}throw Error("Failed to generate a unique content ID after multiple attempts")}},23946:(e,t,r)=>{"use strict";r.d(t,{Yl:()=>a,qc:()=>s});let n={guest:0,uploader:1,admin:2};function i(e,t){let r=n[e],i=n[t];return void 0!==r&&void 0!==i&&r>=i}function a(e){return i(e,"uploader")}function s(e){return i(e,"admin")}},4886:(e,t,r)=>{"use strict";r.d(t,{mH:()=>u,sM:()=>l});var n=r(9288),i=r.n(n),a=r(88479);let s=new Set(["image/jpeg","image/png","image/gif","image/webp","image/avif","image/tiff","image/bmp"]);async function o(e){try{return await i()(e).resize(200,200,{fit:"inside",withoutEnlargement:!0}).jpeg({quality:50,progressive:!0}).toBuffer()}catch{return null}}async function l(e,t,r,n){if(!s.has(t))return null;let i=await o(e);if(!i)return null;let l=`preview-${r}.jpg`;try{return await (0,a.OJ)(i,l,n)}catch{return null}}async function u(e){if(e)try{await (0,a.Ww)(e)}catch{}}},84908:(e,t,r)=>{"use strict";r.d(t,{z:()=>o});var n=r(96330),i=r(64981),a=r(33873),s=r.n(a);let o=globalThis.prisma??function(){let e=function(){let e=process.env.DATABASE_URL||"file:./dev.db";if(e.startsWith("file:")){let t=e.slice(5),r=s().resolve(process.cwd(),t);return`file:${r}`}return e}(),t=new i.C({url:e});return new n.PrismaClient({adapter:t})}()},88479:(e,t,r)=>{"use strict";r.d(t,{OJ:()=>u,Ww:()=>c,oK:()=>d});var n=r(79748),i=r.n(n),a=r(29021),s=r(33873),o=r.n(s),l=r(21950);async function u(e,t,r){let n=function(e){let t=e?o().join(l.S_,e):l.S_,r=o().resolve(t),n=o().resolve(l.S_);if(r!==n&&!r.startsWith(n+o().sep))throw Error("Path traversal detected in directory");return(0,a.existsSync)(t)||(0,a.mkdirSync)(t,{recursive:!0}),t}(r),s=o().join(n,t),u=o().resolve(s),d=o().resolve(l.S_);if(u!==d&&!u.startsWith(d+o().sep))throw Error("Path traversal detected");return await i().writeFile(s,e),o().relative(l.S_,s)}function d(e){let t=o().resolve(o().join(l.S_,e)),r=o().resolve(l.S_);if(t!==r&&!t.startsWith(r+o().sep))throw Error("Path traversal detected");return t}async function c(e){let t=d(e);try{await i().unlink(t)}catch(e){if("ENOENT"!==e.code)throw e}}},99111:(e,t,r)=>{"use strict";function n(){return process.env.BASE_URL?process.env.BASE_URL.replace(/\/+$/,""):`http://localhost:${process.env.PORT||3e3}`}function i(){return process.env.CONTENT_URL?process.env.CONTENT_URL.replace(/\/+$/,""):n()}r.d(t,{$:()=>n,D:()=>i})},83635:(e,t,r)=>{"use strict";r.d(t,{Bu:()=>v,Ft:()=>p,Gg:()=>c,Ky:()=>d,Nz:()=>u,So:()=>f,UT:()=>h,Xf:()=>w,mw:()=>m});var n=r(29859),i=r(33873),a=r.n(i),s=r(21950),o=r(23946),l=r(84908);function u(e){let t=a().basename(e);if((t=(t=t.replace(/[^a-zA-Z0-9._-]/g,"_")).replace(/^\.+/,"")).length>200){let e=a().extname(t);t=t.substring(0,200-e.length)+e}return t&&""!==t||(t="unnamed_file"),t}function d(e){let t=a().extname(e).toLowerCase();if(!t)return{valid:!1,extension:"",error:"File must have an extension"};let r=e.toLowerCase().split(".");for(let e=1;e<r.length-1;e++){let t="."+r[e];if(s.AW.has(t))return{valid:!1,extension:t,error:`Filename contains blocked extension '${t}'`}}return s.AW.has(t)?{valid:!1,extension:t,error:`File extension '${t}' is blocked for security reasons`}:s.C1.has(t)?{valid:!0,extension:t}:{valid:!1,extension:t,error:`File extension '${t}' is not allowed`}}function c(e){return e<=0?{valid:!1,error:"File is empty"}:e>s.w3?{valid:!1,error:`File exceeds maximum size of ${s.w3/1048576}MB`}:{valid:!0}}async function p(e,t,r){let n=s.pD[t]??0;if(0===n)return{valid:!1,currentUsage:0,limit:0,error:"Your role does not allow uploads"};let i=(await l.z.content.aggregate({where:{uploadedById:e,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},_sum:{fileSize:!0}}))._sum.fileSize??0;if(i+r>n){let e=(i/1048576).toFixed(1),t=(n/1048576).toFixed(0);return{valid:!1,currentUsage:i,limit:n,error:`Storage limit exceeded. Used: ${e}MB / ${t}MB. Cannot add ${(r/1048576).toFixed(1)}MB.`}}return{valid:!0,currentUsage:i,limit:n}}function f(e,t){if("off"===t||null===t)return(0,o.qc)(e)?{valid:!0,expiresAt:null}:{valid:!1,expiresAt:null,error:"Only admins can set content to never expire"};let r=parseFloat(t);return isNaN(r)||r<=0?{valid:!1,expiresAt:null,error:"Invalid expiry time"}:60*r<s.bD?{valid:!1,expiresAt:null,error:`Expiry must be at least ${s.bD} minutes`}:!(0,o.qc)(e)&&r>s.ED?{valid:!1,expiresAt:null,error:`Uploaders can set expiry up to ${s.ED} hours (7 days)`}:{valid:!0,expiresAt:new Date(Date.now()+36e5*r)}}async function w(e,t,r){let n=s.pD[t]??0;return l.z.$transaction(async t=>{let i=(await t.content.aggregate({where:{uploadedById:e,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},_sum:{fileSize:!0}}))._sum.fileSize??0;if(i+r.fileSize>n){let e=(i/1048576).toFixed(1),t=(n/1048576).toFixed(0);throw new v(`Storage limit exceeded. Used: ${e}MB / ${t}MB. Cannot add ${(r.fileSize/1048576).toFixed(1)}MB.`)}return t.content.create({data:r})})}function h(e){let t=e.trim().toLowerCase();return t?t.length>100?{valid:!1,slug:t,error:"Short slug must be 100 characters or fewer"}:/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(t)?{valid:!0,slug:t}:{valid:!1,slug:t,error:"Short slug may only contain lowercase letters, numbers, and hyphens (no leading/trailing/consecutive hyphens)"}:{valid:!1,slug:"",error:"Short slug cannot be empty"}}async function m(e,t){let r=await l.z.shortSlug.findUnique({where:{slug:e}});return r&&r.contentId!==t?{taken:!0,error:`Short slug '${e}' is already in use`}:{taken:!1}}class v extends Error{constructor(e){super(e),this.name="StorageLimitError"}}n.Ikc({filename:n.YjP().optional(),expiry:n.YjP().default("1"),directory:n.YjP().optional()})}};