(()=>{var e={};e.id=4481,e.ids=[4481],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},87550:e=>{"use strict";e.exports=require("better-sqlite3")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},9288:e=>{"use strict";e.exports=require("sharp")},55511:e=>{"use strict";e.exports=require("crypto")},29021:e=>{"use strict";e.exports=require("fs")},79748:e=>{"use strict";e.exports=require("fs/promises")},33873:e=>{"use strict";e.exports=require("path")},69562:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>x,serverHooks:()=>y,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>v});var n={};r.r(n),r.d(n,{DELETE:()=>m,GET:()=>w,PUT:()=>h});var s=r(42706),i=r(28203),a=r(45994),o=r(39187),l=r(60809),u=r(84908),d=r(23946),c=r(88479),p=r(4886),f=r(83635);async function w(e,{params:t}){let r=await (0,l.j2)();if(!r?.user||!(0,d.qc)(r.user.role))return o.NextResponse.json({error:"Forbidden"},{status:403});let{id:n}=await t,s=await u.z.content.findUnique({where:{id:n},select:{id:!0,filename:!0,originalFilename:!0,directory:!0,fileSize:!0,fileExtension:!0,mimeType:!0,expiresAt:!0,createdAt:!0,previewPath:!0,uploadedBy:{select:{id:!0,username:!0,role:!0}},shortSlugs:{select:{slug:!0}}}});if(!s)return o.NextResponse.json({error:"Content not found"},{status:404});let{previewPath:i,...a}=s;return o.NextResponse.json({content:{...a,hasPreview:!!i}})}async function h(e,{params:t}){let r=await (0,l.j2)();if(!r?.user||!(0,d.qc)(r.user.role))return o.NextResponse.json({error:"Forbidden"},{status:403});let{id:n}=await t;try{let{filename:t,expiresAt:r,addSlugs:s,removeSlugs:i}=await e.json();if(!await u.z.content.findUnique({where:{id:n}}))return o.NextResponse.json({error:"Content not found"},{status:404});let a={};if(void 0!==t&&(a.filename=(0,f.Nz)(t)),void 0!==r&&(a.expiresAt=r?new Date(r):null),await u.z.content.update({where:{id:n},data:a}),Array.isArray(s)&&s.length>0)for(let e of s){let t=(0,f.UT)(e);if(!t.valid)return o.NextResponse.json({error:t.error},{status:400});let r=await (0,f.mw)(t.slug,n);if(r.taken)return o.NextResponse.json({error:r.error},{status:409});await u.z.shortSlug.create({data:{slug:t.slug,contentId:n}})}Array.isArray(i)&&i.length>0&&await u.z.shortSlug.deleteMany({where:{contentId:n,slug:{in:i}}});let l=await u.z.content.findUnique({where:{id:n},select:{id:!0,filename:!0,originalFilename:!0,directory:!0,fileSize:!0,fileExtension:!0,mimeType:!0,expiresAt:!0,createdAt:!0,previewPath:!0,shortSlugs:{select:{slug:!0}}}});if(!l)return o.NextResponse.json({error:"Content not found"},{status:404});let{previewPath:d,...c}=l;return o.NextResponse.json({content:{...c,hasPreview:!!d}})}catch(e){return console.error("Update content error:",e),o.NextResponse.json({error:"Failed to update content"},{status:500})}}async function m(e,{params:t}){let r=await (0,l.j2)();if(!r?.user||!(0,d.qc)(r.user.role))return o.NextResponse.json({error:"Forbidden"},{status:403});let{id:n}=await t,s=await u.z.content.findUnique({where:{id:n}});return s?(await (0,c.Ww)(s.storagePath),await (0,p.mH)(s.previewPath),await u.z.content.delete({where:{id:n}}),o.NextResponse.json({success:!0})):o.NextResponse.json({error:"Content not found"},{status:404})}let x=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/admin/content/[id]/route",pathname:"/api/admin/content/[id]",filename:"route",bundlePath:"app/api/admin/content/[id]/route"},resolvedPagePath:"/home/runner/work/PartFiles/PartFiles/src/app/api/admin/content/[id]/route.ts",nextConfigOutput:"standalone",userland:n}),{workAsyncStorage:g,workUnitAsyncStorage:v,serverHooks:y}=x;function A(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:v})}},96487:()=>{},78335:()=>{},60809:(e,t,r)=>{"use strict";r.d(t,{j2:()=>w,Y9:()=>c});var n=r(57971),s=r(23352),i=r(34926),a=r(84908);let o={pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role),e),authorized({auth:e,request:{nextUrl:t,headers:r}}){let n=e?.user?.role,s=!!e?.user&&!!n,i=t.pathname;if(i.startsWith("/login")||i.startsWith("/invite")||i.startsWith("/api/auth")||i.startsWith("/api/invite")||i.startsWith("/api/preview")||/^(\/api\/content\/[^/]+(\/raw)?)$/.test(i)||/^(\/(c|r|s|e)\/[^/]+)$/.test(i)||i.startsWith("/api/cron"))return!0;let a=function(e,t){let r=t.get("x-forwarded-host"),n=t.get("x-forwarded-proto")||"https";return r?`${n}://${r}`:e.origin}(t,r);if(!s){if(r.get("x-forwarded-host")){let e=new URL("/login",a);return e.searchParams.set("callbackUrl",t.pathname+t.search),Response.redirect(e)}return!1}return!((i.startsWith("/admin")||i.startsWith("/api/admin"))&&"admin"!==n||("/upload"===i||i.startsWith("/api/upload"))&&"admin"!==n&&"uploader"!==n)||Response.redirect(new URL("/dashboard",a))}},providers:[],session:{strategy:"jwt"}},l=new Map,u=Date.now();function d(){let e=Date.now();if(!(e-u<3e5))for(let[t,r]of(u=e,l))e>r.resetAt&&l.delete(t)}let{handlers:c,signIn:p,signOut:f,auth:w}=(0,n.Ay)({...o,callbacks:{...o.callbacks,async jwt({token:e,user:t}){if(t)return e.id=t.id,e.role=t.role,e.revalidatedAt=Date.now(),e;let r=e.revalidatedAt??0;if(Date.now()-r>3e5){let t=await a.z.user.findUnique({where:{id:e.id},select:{id:!0,role:!0}});if(!t)return e.id=void 0,e.role=void 0,e.revalidatedAt=void 0,e;e.role=t.role,e.revalidatedAt=Date.now()}return e}},providers:[(0,s.A)({name:"credentials",credentials:{username:{label:"Username",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.username||!e?.password)return null;let t=e.username.toLowerCase(),r=e.password;if(function(e){d();let t=Date.now(),r=l.get(e);return!!r&&!(t>r.resetAt)&&r.failures>=5}(t))return null;let n=await a.z.user.findUnique({where:{username:t}});return n&&(0,i.Dm)(r,n.passwordHash)?(l.delete(t),{id:n.id,name:n.username,role:n.role}):(function(e){d();let t=Date.now(),r=l.get(e);!r||t>r.resetAt?l.set(e,{failures:1,resetAt:t+9e5}):(r.failures++,r.failures)}(t),null)}})]})},21950:(e,t,r)=>{"use strict";r.d(t,{AW:()=>p,C1:()=>c,ED:()=>l,S_:()=>f,bD:()=>d,gg:()=>i,pD:()=>a,w3:()=>o,y2:()=>u});var n=r(33873),s=r.n(n);let i=["admin","uploader","guest"],a={admin:0x80000000,uploader:524288e3,guest:0},o=0x6400000,l=168,u=1,d=5,c=new Set([".jpg",".jpeg",".png",".gif",".webp",".bmp",".ico",".tiff",".avif",".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".odt",".ods",".odp",".txt",".csv",".rtf",".zip",".tar",".gz",".bz2",".7z",".rar",".mp3",".mp4",".wav",".ogg",".webm",".avi",".mov",".flv",".mkv",".json",".xml",".yaml",".yml",".woff",".woff2",".ttf",".otf",".eot"]),p=new Set([".html",".htm",".js",".jsx",".ts",".tsx",".svg",".php",".asp",".aspx",".jsp",".cgi",".sh",".bash",".bat",".cmd",".exe",".msi",".dll",".so",".dylib",".phtml",".phar",".htaccess",".htpasswd",".xslt"]),f=process.env.UPLOAD_DIR||s().join(process.cwd(),"uploads");if((process.env.AUTH_SECRET||process.env.NEXTAUTH_SECRET||"").length<32)throw Error("AUTH_SECRET (or NEXTAUTH_SECRET) must be set and at least 32 characters in production. Generate one with: openssl rand -base64 32")},23946:(e,t,r)=>{"use strict";r.d(t,{Yl:()=>i,qc:()=>a});let n={guest:0,uploader:1,admin:2};function s(e,t){let r=n[e],s=n[t];return void 0!==r&&void 0!==s&&r>=s}function i(e){return s(e,"uploader")}function a(e){return s(e,"admin")}},4886:(e,t,r)=>{"use strict";r.d(t,{mH:()=>u,sM:()=>l});var n=r(9288),s=r.n(n),i=r(88479);let a=new Set(["image/jpeg","image/png","image/gif","image/webp","image/avif","image/tiff","image/bmp"]);async function o(e){try{return await s()(e).resize(200,200,{fit:"inside",withoutEnlargement:!0}).jpeg({quality:50,progressive:!0}).toBuffer()}catch{return null}}async function l(e,t,r,n){if(!a.has(t))return null;let s=await o(e);if(!s)return null;let l=`preview-${r}.jpg`;try{return await (0,i.OJ)(s,l,n)}catch{return null}}async function u(e){if(e)try{await (0,i.Ww)(e)}catch{}}},84908:(e,t,r)=>{"use strict";r.d(t,{z:()=>o});var n=r(96330),s=r(64981),i=r(33873),a=r.n(i);let o=globalThis.prisma??function(){let e=function(){let e=process.env.DATABASE_URL||"file:./dev.db";if(e.startsWith("file:")){let t=e.slice(5),r=a().resolve(process.cwd(),t);return`file:${r}`}return e}(),t=new s.C({url:e});return new n.PrismaClient({adapter:t})}()},88479:(e,t,r)=>{"use strict";r.d(t,{OJ:()=>u,Ww:()=>c,oK:()=>d});var n=r(79748),s=r.n(n),i=r(29021),a=r(33873),o=r.n(a),l=r(21950);async function u(e,t,r){let n=function(e){let t=e?o().join(l.S_,e):l.S_,r=o().resolve(t),n=o().resolve(l.S_);if(r!==n&&!r.startsWith(n+o().sep))throw Error("Path traversal detected in directory");return(0,i.existsSync)(t)||(0,i.mkdirSync)(t,{recursive:!0}),t}(r),a=o().join(n,t),u=o().resolve(a),d=o().resolve(l.S_);if(u!==d&&!u.startsWith(d+o().sep))throw Error("Path traversal detected");return await s().writeFile(a,e),o().relative(l.S_,a)}function d(e){let t=o().resolve(o().join(l.S_,e)),r=o().resolve(l.S_);if(t!==r&&!t.startsWith(r+o().sep))throw Error("Path traversal detected");return t}async function c(e){let t=d(e);try{await s().unlink(t)}catch(e){if("ENOENT"!==e.code)throw e}}},83635:(e,t,r)=>{"use strict";r.d(t,{Bu:()=>x,Ft:()=>p,Gg:()=>c,Ky:()=>d,Nz:()=>u,So:()=>f,UT:()=>h,Xf:()=>w,mw:()=>m});var n=r(29859),s=r(33873),i=r.n(s),a=r(21950),o=r(23946),l=r(84908);function u(e){let t=i().basename(e);if((t=(t=t.replace(/[^a-zA-Z0-9._-]/g,"_")).replace(/^\.+/,"")).length>200){let e=i().extname(t);t=t.substring(0,200-e.length)+e}return t&&""!==t||(t="unnamed_file"),t}function d(e){let t=i().extname(e).toLowerCase();if(!t)return{valid:!1,extension:"",error:"File must have an extension"};let r=e.toLowerCase().split(".");for(let e=1;e<r.length-1;e++){let t="."+r[e];if(a.AW.has(t))return{valid:!1,extension:t,error:`Filename contains blocked extension '${t}'`}}return a.AW.has(t)?{valid:!1,extension:t,error:`File extension '${t}' is blocked for security reasons`}:a.C1.has(t)?{valid:!0,extension:t}:{valid:!1,extension:t,error:`File extension '${t}' is not allowed`}}function c(e){return e<=0?{valid:!1,error:"File is empty"}:e>a.w3?{valid:!1,error:`File exceeds maximum size of ${a.w3/1048576}MB`}:{valid:!0}}async function p(e,t,r){let n=a.pD[t]??0;if(0===n)return{valid:!1,currentUsage:0,limit:0,error:"Your role does not allow uploads"};let s=(await l.z.content.aggregate({where:{uploadedById:e,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},_sum:{fileSize:!0}}))._sum.fileSize??0;if(s+r>n){let e=(s/1048576).toFixed(1),t=(n/1048576).toFixed(0);return{valid:!1,currentUsage:s,limit:n,error:`Storage limit exceeded. Used: ${e}MB / ${t}MB. Cannot add ${(r/1048576).toFixed(1)}MB.`}}return{valid:!0,currentUsage:s,limit:n}}function f(e,t){if("off"===t||null===t)return(0,o.qc)(e)?{valid:!0,expiresAt:null}:{valid:!1,expiresAt:null,error:"Only admins can set content to never expire"};let r=parseFloat(t);return isNaN(r)||r<=0?{valid:!1,expiresAt:null,error:"Invalid expiry time"}:60*r<a.bD?{valid:!1,expiresAt:null,error:`Expiry must be at least ${a.bD} minutes`}:!(0,o.qc)(e)&&r>a.ED?{valid:!1,expiresAt:null,error:`Uploaders can set expiry up to ${a.ED} hours (7 days)`}:{valid:!0,expiresAt:new Date(Date.now()+36e5*r)}}async function w(e,t,r){let n=a.pD[t]??0;return l.z.$transaction(async t=>{let s=(await t.content.aggregate({where:{uploadedById:e,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},_sum:{fileSize:!0}}))._sum.fileSize??0;if(s+r.fileSize>n){let e=(s/1048576).toFixed(1),t=(n/1048576).toFixed(0);throw new x(`Storage limit exceeded. Used: ${e}MB / ${t}MB. Cannot add ${(r.fileSize/1048576).toFixed(1)}MB.`)}return t.content.create({data:r})})}function h(e){let t=e.trim().toLowerCase();return t?t.length>100?{valid:!1,slug:t,error:"Short slug must be 100 characters or fewer"}:/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(t)?{valid:!0,slug:t}:{valid:!1,slug:t,error:"Short slug may only contain lowercase letters, numbers, and hyphens (no leading/trailing/consecutive hyphens)"}:{valid:!1,slug:"",error:"Short slug cannot be empty"}}async function m(e,t){let r=await l.z.shortSlug.findUnique({where:{slug:e}});return r&&r.contentId!==t?{taken:!0,error:`Short slug '${e}' is already in use`}:{taken:!1}}class x extends Error{constructor(e){super(e),this.name="StorageLimitError"}}n.Ikc({filename:n.YjP().optional(),expiry:n.YjP().default("1"),directory:n.YjP().optional()})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638,9187,4981,4926,2787,5522,2070],()=>r(69562));module.exports=n})();