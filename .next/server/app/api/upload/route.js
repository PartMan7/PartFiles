"use strict";(()=>{var e={};e.id=5413,e.ids=[5413],e.modules={96330:e=>{e.exports=require("@prisma/client")},87550:e=>{e.exports=require("better-sqlite3")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},19121:e=>{e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},9288:e=>{e.exports=require("sharp")},55511:e=>{e.exports=require("crypto")},29021:e=>{e.exports=require("fs")},79748:e=>{e.exports=require("fs/promises")},33873:e=>{e.exports=require("path")},77598:e=>{e.exports=require("node:crypto")},68965:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>h,routeModule:()=>g,serverHooks:()=>R,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>q});var s={};t.r(s),t.d(s,{POST:()=>w});var o=t(42706),i=t(28203),a=t(45994),n=t(39187),p=t(60809),u=t(23946),l=t(83635),d=t(88479),x=t(4886),f=t(824),c=t(53377),m=t(21950),j=t(99111),v=t(82085);async function w(e){let r=await (0,p.j2)();if(!r?.user)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{id:t,role:s}=r.user;if(!(0,u.Yl)(s))return n.NextResponse.json({error:"Forbidden: insufficient permissions"},{status:403});let o=null,i=null;try{let r=await e.formData(),a=r.get("file"),p=r.get("filename"),u=r.get("expiry")||String(m.y2);if(!a)return n.NextResponse.json({error:"No file provided"},{status:400});let w=(0,l.Gg)(a.size);if(!w.valid)return n.NextResponse.json({error:w.error},{status:400});let g=a.name||"unnamed",y=(0,l.Ky)(g);if(!y.valid)return n.NextResponse.json({error:y.error},{status:400});let q=await (0,l.Ft)(t,s,a.size);if(!q.valid)return n.NextResponse.json({error:q.error},{status:400});let R=(0,l.So)(s,u);if(!R.valid)return n.NextResponse.json({error:R.error},{status:400});let h=(0,l.Nz)(p||g),N=`${(0,f.A)()}-${h}`,k=(0,c.lookup)(g)||"application/octet-stream",A=await (0,v.y)(),z=Buffer.from(await a.arrayBuffer());o=await (0,d.OJ)(z,N),i=await (0,x.sM)(z,k,N);let P=await (0,l.Xf)(t,s,{id:A,filename:h,originalFilename:g,storagePath:o,previewPath:i,fileSize:a.size,fileExtension:y.extension,mimeType:k,expiresAt:R.expiresAt,uploadedById:t}),F=(0,j.D)();return n.NextResponse.json({success:!0,content:{id:P.id,filename:P.filename,size:P.fileSize,expiresAt:P.expiresAt,url:`${F}/c/${P.id}`}})}catch(e){if(o)try{await (0,d.Ww)(o)}catch{}if(await (0,x.mH)(i),e instanceof l.Bu)return n.NextResponse.json({error:e.message},{status:400});return console.error("Upload error:",e),n.NextResponse.json({error:"Upload failed"},{status:500})}}let g=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"/home/runner/work/PartFiles/PartFiles/src/app/api/upload/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:q,serverHooks:R}=g;function h(){return(0,a.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:q})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[638,9187,4981,4926,2787,5522,2070,1e3,6904],()=>t(68965));module.exports=s})();