(()=>{var e={};e.id=3503,e.ids=[3503],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},87550:e=>{"use strict";e.exports=require("better-sqlite3")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},29021:e=>{"use strict";e.exports=require("fs")},79748:e=>{"use strict";e.exports=require("fs/promises")},33873:e=>{"use strict";e.exports=require("path")},76282:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>x,serverHooks:()=>h,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>v});var n={};r.r(n),r.d(n,{GET:()=>m});var i=r(42706),s=r(28203),o=r(45994),a=r(39187),l=r(84908),u=r(88479),d=r(83635),p=r(79748),c=r.n(p);let f=new Set(["image/jpeg","image/png","image/gif","image/webp","image/avif","image/bmp","image/tiff","video/mp4","video/webm","video/ogg","audio/mpeg","audio/ogg","audio/wav","audio/webm","application/pdf","text/plain","text/csv"]);async function m(e,{params:t}){let{slug:r}=await t,n=await l.z.shortSlug.findUnique({where:{slug:r},include:{content:!0}});if(!n)return a.NextResponse.json({error:"Content not found"},{status:404});let i=n.content;if(i.expiresAt&&new Date(i.expiresAt)<new Date)return a.NextResponse.json({error:"Content has expired"},{status:410});try{let e=(0,u.oK)(i.storagePath),t=await c().readFile(e),r=(0,d.Nz)(i.filename).replace(/"/g,"'"),n=f.has(i.mimeType),s=n?`inline; filename="${r}"`:`attachment; filename="${r}"`;return new a.NextResponse(t,{headers:{"Content-Type":i.mimeType,"Content-Disposition":s,"Content-Length":String(i.fileSize),"X-Content-Type-Options":"nosniff","X-Frame-Options":"DENY","Content-Security-Policy":n?"default-src 'none'; img-src 'self'; media-src 'self'; style-src 'unsafe-inline'":"default-src 'none'","Cache-Control":"private, no-cache"}})}catch{return a.NextResponse.json({error:"File not found on disk"},{status:404})}}let x=new i.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/s/[slug]/route",pathname:"/api/s/[slug]",filename:"route",bundlePath:"app/api/s/[slug]/route"},resolvedPagePath:"/home/runner/work/PartFiles/PartFiles/src/app/api/s/[slug]/route.ts",nextConfigOutput:"standalone",userland:n}),{workAsyncStorage:g,workUnitAsyncStorage:v,serverHooks:h}=x;function w(){return(0,o.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:v})}},96487:()=>{},78335:()=>{},21950:(e,t,r)=>{"use strict";r.d(t,{AW:()=>c,C1:()=>p,ED:()=>l,S_:()=>f,bD:()=>d,gg:()=>s,pD:()=>o,w3:()=>a,y2:()=>u});var n=r(33873),i=r.n(n);let s=["admin","uploader","guest"],o={admin:0x80000000,uploader:524288e3,guest:0},a=0x6400000,l=168,u=1,d=5,p=new Set([".jpg",".jpeg",".png",".gif",".webp",".bmp",".ico",".tiff",".avif",".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".odt",".ods",".odp",".txt",".csv",".rtf",".zip",".tar",".gz",".bz2",".7z",".rar",".mp3",".mp4",".wav",".ogg",".webm",".avi",".mov",".flv",".mkv",".json",".xml",".yaml",".yml",".woff",".woff2",".ttf",".otf",".eot"]),c=new Set([".html",".htm",".js",".jsx",".ts",".tsx",".svg",".php",".asp",".aspx",".jsp",".cgi",".sh",".bash",".bat",".cmd",".exe",".msi",".dll",".so",".dylib",".phtml",".phar",".htaccess",".htpasswd",".xslt"]),f=process.env.UPLOAD_DIR||i().join(process.cwd(),"uploads");if((process.env.AUTH_SECRET||process.env.NEXTAUTH_SECRET||"").length<32)throw Error("AUTH_SECRET (or NEXTAUTH_SECRET) must be set and at least 32 characters in production. Generate one with: openssl rand -base64 32")},23946:(e,t,r)=>{"use strict";r.d(t,{Yl:()=>s,qc:()=>o});let n={guest:0,uploader:1,admin:2};function i(e,t){let r=n[e],i=n[t];return void 0!==r&&void 0!==i&&r>=i}function s(e){return i(e,"uploader")}function o(e){return i(e,"admin")}},84908:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var n=r(96330),i=r(64981),s=r(33873),o=r.n(s);let a=globalThis.prisma??function(){let e=function(){let e=process.env.DATABASE_URL||"file:./dev.db";if(e.startsWith("file:")){let t=e.slice(5),r=o().resolve(process.cwd(),t);return`file:${r}`}return e}(),t=new i.C({url:e});return new n.PrismaClient({adapter:t})}()},88479:(e,t,r)=>{"use strict";r.d(t,{OJ:()=>u,Ww:()=>p,oK:()=>d});var n=r(79748),i=r.n(n),s=r(29021),o=r(33873),a=r.n(o),l=r(21950);async function u(e,t,r){let n=function(e){let t=e?a().join(l.S_,e):l.S_,r=a().resolve(t),n=a().resolve(l.S_);if(r!==n&&!r.startsWith(n+a().sep))throw Error("Path traversal detected in directory");return(0,s.existsSync)(t)||(0,s.mkdirSync)(t,{recursive:!0}),t}(r),o=a().join(n,t),u=a().resolve(o),d=a().resolve(l.S_);if(u!==d&&!u.startsWith(d+a().sep))throw Error("Path traversal detected");return await i().writeFile(o,e),a().relative(l.S_,o)}function d(e){let t=a().resolve(a().join(l.S_,e)),r=a().resolve(l.S_);if(t!==r&&!t.startsWith(r+a().sep))throw Error("Path traversal detected");return t}async function p(e){let t=d(e);try{await i().unlink(t)}catch(e){if("ENOENT"!==e.code)throw e}}},83635:(e,t,r)=>{"use strict";r.d(t,{Bu:()=>v,Ft:()=>c,Gg:()=>p,Ky:()=>d,Nz:()=>u,So:()=>f,UT:()=>x,Xf:()=>m,mw:()=>g});var n=r(29859),i=r(33873),s=r.n(i),o=r(21950),a=r(23946),l=r(84908);function u(e){let t=s().basename(e);if((t=(t=t.replace(/[^a-zA-Z0-9._-]/g,"_")).replace(/^\.+/,"")).length>200){let e=s().extname(t);t=t.substring(0,200-e.length)+e}return t&&""!==t||(t="unnamed_file"),t}function d(e){let t=s().extname(e).toLowerCase();if(!t)return{valid:!1,extension:"",error:"File must have an extension"};let r=e.toLowerCase().split(".");for(let e=1;e<r.length-1;e++){let t="."+r[e];if(o.AW.has(t))return{valid:!1,extension:t,error:`Filename contains blocked extension '${t}'`}}return o.AW.has(t)?{valid:!1,extension:t,error:`File extension '${t}' is blocked for security reasons`}:o.C1.has(t)?{valid:!0,extension:t}:{valid:!1,extension:t,error:`File extension '${t}' is not allowed`}}function p(e){return e<=0?{valid:!1,error:"File is empty"}:e>o.w3?{valid:!1,error:`File exceeds maximum size of ${o.w3/1048576}MB`}:{valid:!0}}async function c(e,t,r){let n=o.pD[t]??0;if(0===n)return{valid:!1,currentUsage:0,limit:0,error:"Your role does not allow uploads"};let i=(await l.z.content.aggregate({where:{uploadedById:e,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},_sum:{fileSize:!0}}))._sum.fileSize??0;if(i+r>n){let e=(i/1048576).toFixed(1),t=(n/1048576).toFixed(0);return{valid:!1,currentUsage:i,limit:n,error:`Storage limit exceeded. Used: ${e}MB / ${t}MB. Cannot add ${(r/1048576).toFixed(1)}MB.`}}return{valid:!0,currentUsage:i,limit:n}}function f(e,t){if("off"===t||null===t)return(0,a.qc)(e)?{valid:!0,expiresAt:null}:{valid:!1,expiresAt:null,error:"Only admins can set content to never expire"};let r=parseFloat(t);return isNaN(r)||r<=0?{valid:!1,expiresAt:null,error:"Invalid expiry time"}:60*r<o.bD?{valid:!1,expiresAt:null,error:`Expiry must be at least ${o.bD} minutes`}:!(0,a.qc)(e)&&r>o.ED?{valid:!1,expiresAt:null,error:`Uploaders can set expiry up to ${o.ED} hours (7 days)`}:{valid:!0,expiresAt:new Date(Date.now()+36e5*r)}}async function m(e,t,r){let n=o.pD[t]??0;return l.z.$transaction(async t=>{let i=(await t.content.aggregate({where:{uploadedById:e,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]},_sum:{fileSize:!0}}))._sum.fileSize??0;if(i+r.fileSize>n){let e=(i/1048576).toFixed(1),t=(n/1048576).toFixed(0);throw new v(`Storage limit exceeded. Used: ${e}MB / ${t}MB. Cannot add ${(r.fileSize/1048576).toFixed(1)}MB.`)}return t.content.create({data:r})})}function x(e){let t=e.trim().toLowerCase();return t?t.length>100?{valid:!1,slug:t,error:"Short slug must be 100 characters or fewer"}:/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(t)?{valid:!0,slug:t}:{valid:!1,slug:t,error:"Short slug may only contain lowercase letters, numbers, and hyphens (no leading/trailing/consecutive hyphens)"}:{valid:!1,slug:"",error:"Short slug cannot be empty"}}async function g(e,t){let r=await l.z.shortSlug.findUnique({where:{slug:e}});return r&&r.contentId!==t?{taken:!0,error:`Short slug '${e}' is already in use`}:{taken:!1}}class v extends Error{constructor(e){super(e),this.name="StorageLimitError"}}n.Ikc({filename:n.YjP().optional(),expiry:n.YjP().default("1"),directory:n.YjP().optional()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638,9187,4981,2070],()=>r(76282));module.exports=n})();